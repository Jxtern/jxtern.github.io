<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relaxing Revision Timer</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#7dd3fc;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.04);
      --radius:16px;
      --glass-2: rgba(255,255,255,0.02);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8}

    /* animated gradient background */
    .bg-anim{
      position:fixed;inset:0;z-index:-2;overflow:hidden;
      background: linear-gradient(120deg,#071029 0%, #081b2d 40%, #092636 60%, #071029 100%);
    }
    /* drifting blobs using pseudo elements */
    .bg-anim::before,.bg-anim::after{
      content:"";position:absolute;filter:blur(70px);opacity:.7;transform:translate3d(0,0,0);
      width:800px;height:800px;border-radius:50%;
      mix-blend-mode:screen;animation:float 18s ease-in-out infinite;
    }
    .bg-anim::before{left:-15%;top:-30%;background:radial-gradient(circle at 30% 30%, rgba(125,211,252,.28), transparent 40%), radial-gradient(circle at 70% 70%, rgba(99,102,241,.18), transparent 40%);animation-duration:20s}
    .bg-anim::after{right:-10%;bottom:-30%;background:radial-gradient(circle at 20% 80%, rgba(99,102,241,.25), transparent 40%), radial-gradient(circle at 80% 20%, rgba(139,92,246,.2), transparent 40%);animation-duration:24s;}
    @keyframes float{0%{transform:translateY(0) scale(1)}50%{transform:translateY(-40px) scale(1.05)}100%{transform:translateY(0) scale(1)}}

    /* subtle starfield canvas overlay */
    canvas#stars{position:fixed;inset:0;z-index:-1;pointer-events:none}

    .container{min-height:100vh;display:grid;place-items:center;padding:40px}
    .card{
      width:980px;max-width:95%;background:linear-gradient(180deg,var(--glass),var(--glass-2));border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,.7);backdrop-filter: blur(8px);padding:28px;display:flex;gap:24px;align-items:stretch;
    }

    .left{flex:1;display:flex;flex-direction:column;gap:18px}
    .right{width:360px;min-width:260px}

    h1{margin:0;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px}

    .controls{display:flex;gap:8px;flex-wrap:wrap}
    input[type=number],input[type=time],select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:10px;color:inherit;font-size:14px}
    button{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#012; border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}

    .timer-display{display:flex;align-items:center;gap:22px}
    .ring{width:160px;height:160px;border-radius:50%;display:grid;place-items:center;background:conic-gradient(var(--accent) calc(var(--p)*1%), rgba(255,255,255,0.03) 0);box-shadow:inset 0 -6px 18px rgba(1,6,23,.7);position:relative}
    .ring .time{font-size:26px;font-weight:700}
    .small{font-size:13px;color:var(--muted)}

    .stats{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,0.03);padding:10px 12px;border-radius:12px;font-size:13px}

    .history{max-height:220px;overflow:auto;padding-right:8px}
    .hist-row{display:flex;justify-content:space-between;padding:10px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px}

    footer{margin-top:6px;color:var(--muted);font-size:12px}

    /* responsive */
    @media (max-width:880px){.card{flex-direction:column}.right{width:100%}}
  </style>
</head>
<body>
  <div class="bg-anim"></div>
  <canvas id="stars"></canvas>

  <div class="container">
    <div class="card">
      <div class="left">
        <div>
          <h1>Relaxing Revision Timer</h1>
          <div class="subtitle">Set a calm study session, track overruns, keep session history. Gentle animations and ambient focus features.</div>
        </div>

        <div class="timer-display">
          <div class="ring" id="ring" style="--p:0">
            <div class="time" id="timeText">25:00</div>
            <div class="small" style="position:absolute;bottom:10px;">left</div>
          </div>

          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
              <label class="small">Revision minutes</label>
              <input id="minutesInput" type="number" min="1" value="25" />
              <label class="small">Break minutes</label>
              <input id="breakInput" type="number" min="0" value="5" />
              <select id="modeSelect" title="Session mode">
                <option value="single">Single session</option>
                <option value="pomodoro">Pomodoro: cycles</option>
              </select>
              <input id="cyclesInput" type="number" min="1" value="4" style="width:72px;display:none" />
            </div>

            <div class="controls">
              <button id="startBtn">Start</button>
              <button id="pauseBtn" class="ghost">Pause</button>
              <button id="resetBtn" class="ghost">Reset</button>
              <button id="fullBtn" class="ghost">Focus (Fullscreen)</button>
              <button id="soundBtn" class="ghost">Ambient: Off</button>
            </div>

            <div style="margin-top:12px" class="stats">
              <div class="pill">Elapsed: <span id="elapsed">0:00</span></div>
              <div class="pill">Overrun: <span id="overrun">0:00</span></div>
              <div class="pill">Target: <span id="target">25:00</span></div>
              <div class="pill">Sessions today: <span id="sessionsCount">0</span></div>
            </div>

            <div style="margin-top:10px">
              <label class="small">Session note (optional)</label>
              <input id="note" placeholder="e.g. chapters 3–5, formulas" style="width:100%;margin-top:6px" />
            </div>
          </div>
        </div>

        <footer>Tip: press Start, let the gentle background and ambient sound keep you calm. Timer will track how long you go over and save sessions locally.</footer>
      </div>

      <div class="right">
        <h3 style="margin:0 0 8px 0">History</h3>
        <div class="history" id="history"></div>

        <div style="margin-top:12px;display:flex;gap:8px;">
          <button id="exportBtn" class="ghost">Export CSV</button>
          <button id="clearBtn" class="ghost">Clear History</button>
        </div>

        <div style="margin-top:14px">
          <label class="small">Appearance</label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="accentColor" type="color" value="#7dd3fc" title="Accent color" />
            <button id="resetTheme" class="ghost">Reset theme</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // --- helpers ---
    const pad = n => String(n).padStart(2,'0');
    const formatTime = s => {
      if (s<0) s = Math.abs(s);
      const m = Math.floor(s/60); const sec = Math.floor(s%60); return m+':'+pad(sec);
    }

    // --- elements ---
    const minutesInput = document.getElementById('minutesInput');
    const breakInput = document.getElementById('breakInput');
    const timeText = document.getElementById('timeText');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const fullBtn = document.getElementById('fullBtn');
    const soundBtn = document.getElementById('soundBtn');
    const elapsedLabel = document.getElementById('elapsed');
    const overrunLabel = document.getElementById('overrun');
    const targetLabel = document.getElementById('target');
    const historyEl = document.getElementById('history');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');
    const noteInput = document.getElementById('note');
    const sessionsCount = document.getElementById('sessionsCount');
    const modeSelect = document.getElementById('modeSelect');
    const cyclesInput = document.getElementById('cyclesInput');
    const ring = document.getElementById('ring');
    const accentColor = document.getElementById('accentColor');
    const resetTheme = document.getElementById('resetTheme');

    // --- state ---
    let totalSec = parseInt(minutesInput.value)*60;
    let remaining = totalSec;
    let running = false;
    let interval = null;
    let startedAt = null;
    let pausedAt = null;
    let ambientOn = false;
    let audioCtx, osc, gainNode;

    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem('rev_history')||'[]'); }catch(e){return[]}
    }
    function saveHistory(arr){ localStorage.setItem('rev_history', JSON.stringify(arr)) }

    function renderHistory(){
      const hist = loadHistory(); historyEl.innerHTML='';
      hist.slice().reverse().forEach(h=>{
        const row = document.createElement('div'); row.className='hist-row';
        row.innerHTML = `<div><strong>${h.label||'Study'}</strong><div class='small' style='color:var(--muted)'>${h.target} → ${h.elapsed} ${h.overrun?`(over ${h.overrun})`:''}</div></div><div class='small'>${h.date}</div>`;
        historyEl.appendChild(row);
      });
      sessionsCount.textContent = hist.length;
    }
    renderHistory();

    function updateDisplay(){
      const mins = Math.floor(remaining/60); const secs = Math.floor(remaining%60);
      timeText.textContent = `${pad(mins)}:${pad(secs)}`;
      // ring progress
      const p = Math.max(0, Math.min(100, (1 - remaining/totalSec)*100));
      ring.style.setProperty('--p', p);
      // elapsed and overrun
      const elapsedSec = Math.max(0, totalSec - remaining);
      elapsedLabel.textContent = formatTime(elapsedSec);
      const over = remaining<0? formatTime(Math.abs(remaining)) : '0:00';
      overrunLabel.textContent = over;
      targetLabel.textContent = formatTime(totalSec);
    }

    function startTimer(){
      if (running) return;
      totalSec = parseInt(minutesInput.value)*60;
      remaining = typeof remaining === 'number' && remaining>0 ? remaining : totalSec;
      startedAt = Date.now() - (totalSec-remaining)*1000;
      running = true;
      startBtn.textContent='Running'; startBtn.disabled=true; pauseBtn.disabled=false;
      interval = setInterval(()=>{
        const elapsed = Math.round((Date.now()-startedAt)/1000);
        remaining = totalSec - elapsed;
        updateDisplay();
        if (remaining<=0 && remaining>-1){ // just reached 0
          beep();
          if (!document.hidden) flashTitle('Session finished — overrun tracking on');
        }
      },250);
      if (ambientOn) startAmbient();
    }

    function pauseTimer(){
      if(!running) return;
      clearInterval(interval); running=false; startBtn.textContent='Resume'; startBtn.disabled=false; pauseBtn.disabled=true;
      pausedAt = Date.now(); stopAmbient();
    }
    function resetTimer(){
      clearInterval(interval); running=false; startBtn.textContent='Start'; startBtn.disabled=false; pauseBtn.disabled=false;
      totalSec = parseInt(minutesInput.value)*60; remaining = totalSec; updateDisplay(); stopAmbient();
    }

    function finishSession(){
      const hist = loadHistory();
      hist.push({
        date: new Date().toLocaleString(),
        target: formatTime(totalSec),
        elapsed: formatTime(Math.max(totalSec - Math.max(0,remaining), totalSec)),
        overrun: remaining<0? formatTime(Math.abs(remaining)):null,
        label: noteInput.value || 'Study'
      });
      saveHistory(hist); renderHistory();
    }

    // small beep using WebAudio
    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sine'; o.frequency.value=880; g.gain.value=0.0001;
        o.connect(g); g.connect(ctx.destination);
        const now = ctx.currentTime; g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.15, now+0.02);
        o.start(); g.gain.exponentialRampToValueAtTime(0.0001, now+0.8); o.stop(now+0.9);
      }catch(e){console.warn(e)}
    }

    // ambient oscillator
    function startAmbient(){
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      osc = audioCtx.createOscillator(); gainNode = audioCtx.createGain();
      osc.type='sine'; osc.frequency.value=220; gainNode.gain.value=0.02;
      const filter = audioCtx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=800;
      osc.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
      osc.start();
    }
    function stopAmbient(){ if (audioCtx){ try{ osc.stop(); audioCtx.close(); }catch(e){} audioCtx=null; } }

    // title flash
    let originalTitle = document.title;
    let flashInterval=null;
    function flashTitle(txt){
      let show=false; clearInterval(flashInterval); flashInterval = setInterval(()=>{
        document.title = show? txt : originalTitle; show=!show;
      },900);
      setTimeout(()=>{ clearInterval(flashInterval); document.title=originalTitle; },6000);
    }

    // fullscreen focus
    fullBtn.addEventListener('click', ()=>{
      if (!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
    });

    startBtn.addEventListener('click', ()=>{
      if (startBtn.textContent==='Start' || startBtn.textContent==='Resume') startTimer();
      else { // Running state
        // nothing
      }
    });
    pauseBtn.addEventListener('click', pauseTimer);
    resetBtn.addEventListener('click', ()=>{ resetTimer(); });

    soundBtn.addEventListener('click', ()=>{
      ambientOn = !ambientOn;
      soundBtn.textContent = 'Ambient: ' + (ambientOn? 'On' : 'Off');
      if (!ambientOn) stopAmbient(); else if (running) startAmbient();
    });

    // update inputs
    minutesInput.addEventListener('change', ()=>{ totalSec = parseInt(minutesInput.value)*60; remaining = totalSec; updateDisplay(); });
    modeSelect.addEventListener('change', ()=>{ cyclesInput.style.display = modeSelect.value==='pomodoro'? 'inline-block' : 'none'; });

    // history actions
    exportBtn.addEventListener('click', ()=>{
      const hist = loadHistory(); if (!hist.length) return alert('No sessions to export');
      const csv = ['date,target,elapsed,overrun,label', ...hist.map(h=>[h.date,h.target,h.elapsed,h.overrun||'',`"${(h.label||'').replace(/"/g,'""') }"`].join(','))].join('\n');
      const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='revision-history.csv'; a.click(); URL.revokeObjectURL(url);
    });
    clearBtn.addEventListener('click', ()=>{ if(confirm('Clear history?')){ saveHistory([]); renderHistory(); } });

    // theme
    accentColor.addEventListener('input', ()=>{ document.documentElement.style.setProperty('--accent', accentColor.value); });
    resetTheme.addEventListener('click', ()=>{ document.documentElement.style.setProperty('--accent','#7dd3fc'); accentColor.value='#7dd3fc'; });

    // persist and finish when user stops
    window.addEventListener('beforeunload', ()=>{ if (running) finishSession(); });

    // session end auto-detect when user presses stop by resetting or switching away
    // we'll provide a button to log session manually on end: when user clicks reset after running, it will save session
    resetBtn.addEventListener('click', ()=>{ if (!running && (minutesInput.value>0)) { /* nothing */ } else { finishSession(); } });

    // initial update
    updateDisplay();

    // star canvas
    (function stars(){
      const canvas = document.getElementById('stars'); const ctx = canvas.getContext('2d'); let w,h,stars=[];
      function resize(){ w=canvas.width = innerWidth; h=canvas.height = innerHeight; stars = Array.from({length: Math.floor((w*h)/90000)}, ()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.4+0.2,alpha:Math.random()})); }
      function draw(){ ctx.clearRect(0,0,w,h); for(const s of stars){ ctx.globalAlpha = s.alpha*0.9; ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,1)'; ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); s.alpha += (Math.random()-0.48)*0.02; if (s.alpha<0.2) s.alpha=0.2; if (s.alpha>1) s.alpha=1; s.x += Math.sin(performance.now()/6000 + s.r)/50; }
        requestAnimationFrame(draw);
      }
      addEventListener('resize', resize); resize(); draw();
    })();

    // small accessibility: keyboard shortcut space to start/pause
    window.addEventListener('keydown', e=>{
      if (e.code==='Space'){ e.preventDefault(); if (running) pauseTimer(); else startTimer(); }
    });
  </script>
</body>
</html>
